#!/bin/sh
# Script run after installation/upgrade

set -e

case "$1" in
    configure)
        echo "ğŸ”§ Configuring NAS Web Server..."
        
        # SprawdÅº czy to pierwsza instalacja
        if [ -z "$2" ]; then
            echo "ğŸ†• First installation detected"
            
            # UtwÃ³rz uÅ¼ytkownika i grupÄ™
            if ! getent group nasweb >/dev/null; then
                addgroup --system nasweb
                echo "ğŸ‘¥ Created nasweb group"
            fi
            
            if ! id nasweb >/dev/null 2>&1; then
                adduser --system --no-create-home --home /var/empty \
                        --shell /bin/false --ingroup nasweb nasweb
                echo "ğŸ‘¤ Created nasweb user"
            fi
            
            # JeÅ›li istnieje domyÅ›lna konfiguracja, ale nie ma gÅ‚Ã³wnej
            if [ -f /etc/nas-web/nas-web.conf.default ] && [ ! -f /etc/nas-web/nas-web.conf ]; then
                cp /etc/nas-web/nas-web.conf.default /etc/nas-web/nas-web.conf
                echo "ğŸ“„ Created initial configuration"
            fi
            
        else
            echo "ğŸ”„ Upgrade from version $2 detected"

            # UtwÃ³rz uÅ¼ytkownika i grupÄ™
            if ! getent group nasweb >/dev/null; then
                addgroup --system nasweb
                echo "ğŸ‘¥ Created nasweb group"
            fi

            if ! id nasweb >/dev/null 2>&1; then
                adduser --system --no-create-home --home /var/empty \
                        --shell /bin/false --ingroup nasweb nasweb
                echo "ğŸ‘¤ Created nasweb user"
            fi
            
            # Zachowaj istniejÄ…cÄ… konfiguracjÄ™ podczas upgradÃ³w
            if [ -f /etc/nas-web/nas-web.conf ] && [ -f /etc/nas-web/nas-web.conf.default ]; then
                # Zachowaj tylko jeÅ›li plik konfiguracyjny nie zostaÅ‚ zmodyfikowany
                if ! cmp -s /etc/nas-web/nas-web.conf /etc/nas-web/nas-web.conf.default; then
                    echo "ğŸ“‹ Preserving existing configuration (different from default)"
                else
                    echo "ğŸ“‹ Using default configuration"
                fi
            fi

            # JeÅ›li istnieje domyÅ›lna konfiguracja, ale nie ma gÅ‚Ã³wnej
            if [ -f /etc/nas-web/nas-web.conf.default ] && [ ! -f /etc/nas-web/nas-web.conf ]; then
                cp /etc/nas-web/nas-web.conf.default /etc/nas-web/nas-web.conf
                echo "ğŸ“„ Created initial configuration"
            fi
        fi
        
        # Ustaw prawa wÅ‚asnoÅ›ci
        if [ -d /var/log/nas-web ]; then
            chown -R nasweb:nasweb /var/log/nas-web
            chmod 755 /var/log/nas-web
        fi

        systemctl start nas-web
        
        echo "âœ… Configuration completed"
        ;;
        
    abort-upgrade|abort-remove|abort-deconfigure)
        echo "âŒ Installation aborted"
        ;;
esac

exit 0
