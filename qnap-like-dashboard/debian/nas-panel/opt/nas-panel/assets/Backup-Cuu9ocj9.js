import{_ as xe,u as Se,L as X,r,c as Ie,o as Ce,K as He,b as d,v as Le,d as _,e as y,g as l,w as s,p as se,F as g,l as $,m as v,t as c,h as L,f as h,x as Re,i as ne,k as M,I as N,y as V,z as b,B as ue}from"./index-JqcLm-KS.js";const je={class:"backup-container"},Fe={class:"card-header"},Pe={style:{float:"left"}},Ee={style:{float:"right",color:"var(--el-text-color-secondary)"}},Ke={class:"pagination"},qe=["innerHTML"],Oe={class:"result-content"},Ae={class:"success-message"},We={class:"warning-message"},Ge={__name:"Backup",setup(Ze){const{t:o}=Se(),f=X("notifications")||X("$notify"),x=X("notifications"),ie=r({});Ie(()=>x?.notifications?.value?.filter(e=>!e.read).length||0);const Y=e=>new Date(e).toLocaleString(),ee=e=>{if(e===0)return"0 Bytes";const t=1024,i=["Bytes","KB","MB","GB","TB"],m=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,m)).toFixed(2))+" "+i[m]},p=r({type:"full",name:"",items:[],compression:"medium",includeSystemConfig:!0}),R=r(!1),S=r(!1),ae=r(""),j=r(""),re=[{value:"full",text:o("backup.types.full")},{value:"incremental",text:o("backup.types.incremental")},{value:"differential",text:o("backup.types.differential")}],de=[{value:"documents",text:o("backup.items.documents")},{value:"photos",text:o("backup.items.photos")},{value:"music",text:o("backup.items.music")},{value:"videos",text:o("backup.items.videos")},{value:"configuration",text:o("backup.items.configuration")}],ce=[{value:"none",text:o("backup.compression_levels.none")},{value:"low",text:o("backup.compression_levels.low")},{value:"medium",text:o("backup.compression_levels.medium")},{value:"high",text:o("backup.compression_levels.high")}],pe=async()=>{R.value=!0;try{const e=await V.post("/api/system/backup/create",p.value);x.addNotification({title:"Rozpoczęto tworzenie kopii",message:`Rozpoczęto proces tworzenia kopii "${p.value.name}"`,type:"info",icon:"mdi:backup-restore",duration:5e3}),ae.value="Tworzenie kopii w toku",j.value=`
      <p>Rozpoczęto proces tworzenia kopii zapasowej <strong>${p.value.name}</strong>.</p>
      <p>ID kopii: <code>${e.data.backupId}</code></p>
      <p>Status: <el-tag type="info">W kolejce</el-tag></p>
      <p class="info-text">Rozmiar będzie dostępny po zakończeniu procesu.</p>
    `,S.value=!0,setTimeout(()=>{D(),I(),setTimeout(()=>{x.addNotification({title:"Kopia utworzona",message:`Kopia "${p.value.name}" została pomyślnie utworzona`,type:"success",icon:"mdi:check-circle",duration:8e3}),j.value=`
          <p>Kopia zapasowa <strong>${p.value.name}</strong> została utworzona pomyślnie.</p>
          <p>ID kopii: <code>${e.data.backupId}</code></p>
          <p>Status: <el-tag type="success">Zakończono</el-tag></p>
        `},1e4)},2e3)}catch(e){const t=e.response?.data?.message||"Wystąpił błąd podczas tworzenia kopii zapasowej";x.addNotification({title:"Błąd tworzenia kopii",message:t,type:"error",icon:"mdi:alert-circle",duration:8e3}),b.error(t)}finally{R.value=!1}},F=r([]),z=r(""),P=r(!1),E=r(!0),K=r(!1),q=r(!1),I=async()=>{q.value=!0;try{const e=await V.get("/api/system/backup/list");F.value=e.data.backups}catch(e){const t=e.response?.data?.message||o("backup.fetch_error");f.addNotification({title:o("backup.notification.fetch_error_title"),message:t,type:"error",icon:"mdi:database-alert",duration:6e3}),b.error(t)}finally{q.value=!1}},me=async()=>{try{await ue.confirm(o("backup.restore_confirm"),o("common.warning"),{type:"warning"}),K.value=!0;const e=await V.post("/api/system/backup/restore",{backup_id:z.value,restore_system_config:P.value,verify_integrity:E.value});f.addNotification({title:o("backup.notification.restored_title"),message:o("backup.notification.restored_message",{name:F.value.find(t=>t.id===z.value)?.name||z.value}),type:"success",icon:"mdi:restore",duration:5e3}),b.success(o("backup.restore_success"))}catch(e){if(e!=="cancel"){const t=e.response?.data?.message||o("backup.restore_error");f.addNotification({title:o("backup.notification.restore_error_title"),message:t,type:"error",icon:"mdi:alert-circle",duration:8e3}),b.error(t)}}finally{K.value=!1}},C=r([]),O=r(!1),A=r(1),W=r(10),te=r(0),w=r(null),D=async()=>{O.value=!0;try{const e=await V.get("/api/system/backup/history",{params:{page:A.value,per_page:W.value}});C.value=e.data.backups,te.value=e.data.total,C.value.filter(i=>i.status==="in_progress").length>0&&!w.value&&ye()}catch(e){const t=e.response?.data?.message||o("backup.history_fetch_error");f.addNotification({title:o("backup.notification.history_error_title"),message:t,type:"error",icon:"mdi:history",duration:6e3}),b.error(t)}finally{O.value=!1}},ye=()=>{w.value&&clearInterval(w.value),w.value=setInterval(()=>{C.value.some(t=>t.status==="in_progress")?(D(),I()):(clearInterval(w.value),w.value=null)},1e4)},ve=async e=>{try{const t=await V({method:"get",url:`/api/system/backup/download/${e}`,responseType:"blob"}),i=window.URL.createObjectURL(new Blob([t.data])),m=document.createElement("a");m.href=i;const k=t.headers["content-disposition"];let u=`backup-${e}.tar.gz`;if(k){const U=k.match(/filename="?(.+)"?/);U&&U[1]&&(u=U[1])}m.setAttribute("download",u),document.body.appendChild(m),m.click(),setTimeout(()=>{window.URL.revokeObjectURL(i),m.remove()},100),f.addNotification({title:o("backup.notification.download_started_title"),message:o("backup.notification.download_started_message",{name:u}),type:"info",icon:"mdi:download",duration:4e3}),b.success(o("backup.download_started"))}catch(t){let i=o("backup.download_error");t.response&&(t.response.status===404?i=o("backup.not_found"):t.response.status===423?i=o("backup.not_ready"):i=t.response.data?.error||t.response.statusText),f.addNotification({title:o("backup.notification.download_error_title"),message:i,type:"error",icon:"mdi:download-off",duration:8e3}),b.error(i)}},be=async e=>{try{await ue.confirm(o("backup.delete_confirm"),o("common.warning"),{type:"warning"}),await V.delete(`/api/system/backup/delete/${e}`),f.addNotification({title:o("backup.notification.deleted_title"),message:o("backup.notification.deleted_message"),type:"success",icon:"mdi:delete-empty",duration:5e3}),b.success(o("backup.delete_success")),D(),I()}catch(t){if(t!=="cancel"){const i=t.response?.data?.message||o("backup.delete_error");f.addNotification({title:o("backup.notification.delete_error_title"),message:i,type:"error",icon:"mdi:delete-alert",duration:8e3}),b.error(i)}}},fe=e=>({completed:"success",failed:"danger",in_progress:"warning",queued:"info"})[e]||"",n=r({type:"disabled",dailyTime:"02:00",weeklyDay:"monday",weeklyTime:"02:00",monthlyDay:1,monthlyTime:"02:00",retention:"30d"}),G=r(!1),ke=[{value:"disabled",text:o("backup.schedule_types.disabled")},{value:"daily",text:o("backup.schedule_types.daily")},{value:"weekly",text:o("backup.schedule_types.weekly")},{value:"monthly",text:o("backup.schedule_types.monthly")}],_e=[{value:"monday",text:o("weekdays.monday")},{value:"tuesday",text:o("weekdays.tuesday")},{value:"wednesday",text:o("weekdays.wednesday")},{value:"thursday",text:o("weekdays.thursday")},{value:"friday",text:o("weekdays.friday")},{value:"saturday",text:o("weekdays.saturday")},{value:"sunday",text:o("weekdays.sunday")}],ge=[{value:"7d",text:o("backup.retention_options.7d")},{value:"14d",text:o("backup.retention_options.14d")},{value:"30d",text:o("backup.retention_options.30d")},{value:"90d",text:o("backup.retention_options.90d")},{value:"1y",text:o("backup.retention_options.1y")},{value:"forever",text:o("backup.retention_options.forever")}],he=async()=>{try{const e=await V.get("/api/system/backup/schedule");e.data.schedule&&(n.value={type:e.data.schedule.type||"disabled",dailyTime:e.data.schedule.daily_time||"02:00",weeklyDay:e.data.schedule.weekly_day||"monday",weeklyTime:e.data.schedule.weekly_time||"02:00",monthlyDay:e.data.schedule.monthly_day||1,monthlyTime:e.data.schedule.monthly_time||"02:00",retention:e.data.schedule.retention||"30d"})}catch(e){const t=e.response?.data?.message||o("backup.schedule_load_error");f.addNotification({title:o("backup.notification.schedule_error_title"),message:t,type:"error",icon:"mdi:calendar-alert",duration:6e3}),b.error(t)}},we=async()=>{G.value=!0;try{const e={schedule:{type:n.value.type,retention:n.value.retention}};n.value.type==="daily"?e.schedule.daily_time=n.value.dailyTime:n.value.type==="weekly"?(e.schedule.weekly_day=n.value.weeklyDay,e.schedule.weekly_time=n.value.weeklyTime):n.value.type==="monthly"&&(e.schedule.monthly_day=n.value.monthlyDay,e.schedule.monthly_time=n.value.monthlyTime),await V.post("/api/system/backup/schedule",e),f.addNotification({title:o("backup.notification.schedule_saved_title"),message:o("backup.notification.schedule_saved_message"),type:"success",icon:"mdi:calendar-check",time:new Date(Date.now()-1e3*60*5),read:!1,duration:5e3}),b.success(o("backup.schedule_saved"))}catch(e){const t=e.response?.data?.error||e.response?.data?.message||o("backup.schedule_save_error");f.addNotification({id:1,title:o("backup.notification.schedule_error_title"),message:t,type:"error",icon:"mdi:calendar-alert",duration:8e3}),b.error(t)}finally{G.value=!1}},le=r("create");return Ce(()=>{I(),D(),he()}),He(()=>{Object.values(ie.value).forEach(e=>{clearInterval(e)}),w.value&&clearInterval(w.value)}),(e,t)=>{const i=d("el-icon"),m=d("el-option"),k=d("el-select"),u=d("el-form-item"),U=d("el-input"),Z=d("el-checkbox"),T=d("el-button"),J=d("el-form"),H=d("el-tab-pane"),B=d("el-table-column"),oe=d("el-tag"),Ve=d("el-progress"),$e=d("el-table"),ze=d("el-pagination"),Q=d("el-time-picker"),Te=d("el-input-number"),Be=d("el-tabs"),De=d("el-dialog"),Ue=d("el-card"),Me=Le("loading");return y(),_("div",je,[l(Ue,{shadow:"hover"},{header:s(()=>[h("div",Fe,[l(i,{size:"24"},{default:s(()=>[l(M(N),{icon:"mdi:content-save"})]),_:1}),h("span",null,c(e.$t("backup.title")),1)])]),default:s(()=>[l(Be,{modelValue:le.value,"onUpdate:modelValue":t[17]||(t[17]=a=>le.value=a),class:"backup-tabs"},{default:s(()=>[l(H,{label:e.$t("backup.create"),name:"create"},{default:s(()=>[l(J,{model:p.value,"label-position":"top",onSubmit:se(pe,["prevent"])},{default:s(()=>[l(u,{label:e.$t("backup.type"),required:""},{default:s(()=>[l(k,{modelValue:p.value.type,"onUpdate:modelValue":t[0]||(t[0]=a=>p.value.type=a)},{default:s(()=>[(y(),_(g,null,$(re,a=>l(m,{key:a.value,label:a.text,value:a.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1},8,["label"]),l(u,{label:e.$t("backup.name"),required:""},{default:s(()=>[l(U,{modelValue:p.value.name,"onUpdate:modelValue":t[1]||(t[1]=a=>p.value.name=a)},null,8,["modelValue"])]),_:1},8,["label"]),l(u,{label:e.$t("backup.itemss")},{default:s(()=>[l(k,{modelValue:p.value.items,"onUpdate:modelValue":t[2]||(t[2]=a=>p.value.items=a),multiple:"","collapse-tags":"","collapse-tags-tooltip":""},{default:s(()=>[(y(),_(g,null,$(de,a=>l(m,{key:a.value,label:a.text,value:a.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1},8,["label"]),l(u,{label:e.$t("backup.compression")},{default:s(()=>[l(k,{modelValue:p.value.compression,"onUpdate:modelValue":t[3]||(t[3]=a=>p.value.compression=a)},{default:s(()=>[(y(),_(g,null,$(ce,a=>l(m,{key:a.value,label:a.text,value:a.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1},8,["label"]),l(u,null,{default:s(()=>[l(Z,{modelValue:p.value.includeSystemConfig,"onUpdate:modelValue":t[4]||(t[4]=a=>p.value.includeSystemConfig=a)},{default:s(()=>[v(c(e.$t("backup.include_system_config")),1)]),_:1},8,["modelValue"])]),_:1}),l(u,null,{default:s(()=>[l(T,{type:"primary","native-type":"submit",loading:R.value},{default:s(()=>[v(c(e.$t("backup.create_button")),1)]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1},8,["label"]),l(H,{label:e.$t("backup.restore"),name:"restore"},{default:s(()=>[l(J,{"label-position":"top"},{default:s(()=>[l(u,{label:e.$t("backup.select_backup"),required:""},{default:s(()=>[l(k,{modelValue:z.value,"onUpdate:modelValue":t[5]||(t[5]=a=>z.value=a),filterable:"",loading:q.value},{default:s(()=>[(y(!0),_(g,null,$(F.value,a=>(y(),L(m,{key:a.id,label:a.name,value:a.id,disabled:a.status!=="completed"},{default:s(()=>[h("span",Pe,c(a.name),1),h("span",Ee,c(Y(a.created_at))+" ("+c(ee(a.size))+") ",1)]),_:2},1032,["label","value","disabled"]))),128))]),_:1},8,["modelValue","loading"])]),_:1},8,["label"]),l(u,null,{default:s(()=>[l(Z,{modelValue:P.value,"onUpdate:modelValue":t[6]||(t[6]=a=>P.value=a)},{default:s(()=>[v(c(e.$t("backup.restore_system_config")),1)]),_:1},8,["modelValue"])]),_:1}),l(u,null,{default:s(()=>[l(Z,{modelValue:E.value,"onUpdate:modelValue":t[7]||(t[7]=a=>E.value=a)},{default:s(()=>[v(c(e.$t("backup.verify_integrity")),1)]),_:1},8,["modelValue"])]),_:1}),l(u,null,{default:s(()=>[l(T,{type:"primary",onClick:me,loading:K.value,disabled:!z.value},{default:s(()=>[v(c(e.$t("backup.restore_button")),1)]),_:1},8,["loading","disabled"])]),_:1})]),_:1})]),_:1},8,["label"]),l(H,{label:e.$t("backup.history"),name:"history"},{default:s(()=>[Re((y(),L($e,{data:C.value,"empty-text":"No backups available",style:{width:"100%"}},{default:s(()=>[l(B,{prop:"name",label:e.$t("backup.history_table.name")},null,8,["label"]),l(B,{label:e.$t("backup.history_table.type")},{default:s(({row:a})=>[l(oe,null,{default:s(()=>[v(c(e.$t(`backup.types.${a.type}`)),1)]),_:2},1024)]),_:1},8,["label"]),l(B,{label:e.$t("backup.history_table.date")},{default:s(({row:a})=>[v(c(Y(a.created_at)),1)]),_:1},8,["label"]),l(B,{label:e.$t("backup.history_table.size")},{default:s(({row:a})=>[v(c(ee(a.size)),1)]),_:1},8,["label"]),l(B,{label:e.$t("backup.history_table.status"),width:"150"},{default:s(({row:a})=>[l(oe,{type:fe(a.status),effect:"dark"},{default:s(()=>[v(c(e.$t(`backup.statuses.${a.status}`)),1)]),_:2},1032,["type"]),a.status==="in_progress"?(y(),L(Ve,{key:0,percentage:a.progress||0,"stroke-width":3,"show-text":!1,style:{"margin-top":"5px"}},null,8,["percentage"])):ne("",!0)]),_:1},8,["label"]),l(B,{label:e.$t("backup.history_table.actions"),width:"180"},{default:s(({row:a})=>[l(T,{size:"small",onClick:Ne=>ve(a.id),disabled:a.status!=="completed"},{default:s(()=>[l(i,null,{default:s(()=>[l(M(N),{icon:"mdi:download"})]),_:1})]),_:2},1032,["onClick","disabled"]),l(T,{size:"small",type:"danger",onClick:Ne=>be(a.id)},{default:s(()=>[l(i,null,{default:s(()=>[l(M(N),{icon:"mdi:delete"})]),_:1})]),_:2},1032,["onClick"])]),_:1},8,["label"])]),_:1},8,["data"])),[[Me,O.value]]),h("div",Ke,[l(ze,{"current-page":A.value,"onUpdate:currentPage":t[8]||(t[8]=a=>A.value=a),"page-size":W.value,"onUpdate:pageSize":t[9]||(t[9]=a=>W.value=a),total:te.value,onCurrentChange:D,layout:"prev, pager, next"},null,8,["current-page","page-size","total"])])]),_:1},8,["label"]),l(H,{label:e.$t("backup.schedule"),name:"schedule"},{default:s(()=>[l(J,{model:n.value,"label-position":"top",onSubmit:se(we,["prevent"])},{default:s(()=>[l(u,{label:e.$t("backup.schedule_type")},{default:s(()=>[l(k,{modelValue:n.value.type,"onUpdate:modelValue":t[10]||(t[10]=a=>n.value.type=a)},{default:s(()=>[(y(),_(g,null,$(ke,a=>l(m,{key:a.value,label:a.text,value:a.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1},8,["label"]),n.value.type==="daily"?(y(),L(u,{key:0,label:e.$t("backup.daily_time")},{default:s(()=>[l(Q,{modelValue:n.value.dailyTime,"onUpdate:modelValue":t[11]||(t[11]=a=>n.value.dailyTime=a),format:"HH:mm","value-format":"HH:mm"},null,8,["modelValue"])]),_:1},8,["label"])):n.value.type==="weekly"?(y(),_(g,{key:1},[l(u,{label:e.$t("backup.weekly_day")},{default:s(()=>[l(k,{modelValue:n.value.weeklyDay,"onUpdate:modelValue":t[12]||(t[12]=a=>n.value.weeklyDay=a)},{default:s(()=>[(y(),_(g,null,$(_e,a=>l(m,{key:a.value,label:a.text,value:a.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1},8,["label"]),l(u,{label:e.$t("backup.weekly_time")},{default:s(()=>[l(Q,{modelValue:n.value.weeklyTime,"onUpdate:modelValue":t[13]||(t[13]=a=>n.value.weeklyTime=a),format:"HH:mm","value-format":"HH:mm"},null,8,["modelValue"])]),_:1},8,["label"])],64)):n.value.type==="monthly"?(y(),_(g,{key:2},[l(u,{label:e.$t("backup.monthly_day")},{default:s(()=>[l(Te,{modelValue:n.value.monthlyDay,"onUpdate:modelValue":t[14]||(t[14]=a=>n.value.monthlyDay=a),min:1,max:31},null,8,["modelValue"])]),_:1},8,["label"]),l(u,{label:e.$t("backup.monthly_time")},{default:s(()=>[l(Q,{modelValue:n.value.monthlyTime,"onUpdate:modelValue":t[15]||(t[15]=a=>n.value.monthlyTime=a),format:"HH:mm","value-format":"HH:mm"},null,8,["modelValue"])]),_:1},8,["label"])],64)):ne("",!0),l(u,{label:e.$t("backup.retention")},{default:s(()=>[l(k,{modelValue:n.value.retention,"onUpdate:modelValue":t[16]||(t[16]=a=>n.value.retention=a)},{default:s(()=>[(y(),_(g,null,$(ge,a=>l(m,{key:a.value,label:a.text,value:a.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1},8,["label"]),l(u,null,{default:s(()=>[l(T,{type:"primary","native-type":"submit",loading:G.value},{default:s(()=>[v(c(e.$t("backup.save_schedule")),1)]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1},8,["label"])]),_:1},8,["modelValue"]),l(De,{modelValue:S.value,"onUpdate:modelValue":t[19]||(t[19]=a=>S.value=a),title:ae.value},{footer:s(()=>[l(T,{type:"primary",onClick:t[18]||(t[18]=a=>S.value=!1)},{default:s(()=>[v(c(e.$t("common.close")),1)]),_:1})]),default:s(()=>[h("div",{class:"result-content",innerHTML:j.value},null,8,qe),h("div",Oe,[h("p",Ae,[l(i,null,{default:s(()=>[l(M(N),{icon:"mdi:information-outline"})]),_:1}),v(" "+c(e.$t("backup.creation_started")),1)]),h("p",We,[l(i,null,{default:s(()=>[l(M(N),{icon:"mdi:clock-outline"})]),_:1}),v(" "+c(e.$t("backup.background_warning")),1)])])]),_:1},8,["modelValue","title"])]),_:1})])}}},Qe=xe(Ge,[["__scopeId","data-v-1be64758"]]);export{Qe as default};
