import{_ as H,r as R,c as A,o as X,K as G,b as y,h as C,e as l,w as v,d as u,F as K,l as M,f as r,i as T,g as _,k as S,I as g,t as i,n as N,m as J,y as D}from"./index-JqcLm-KS.js";import"./es6-promise-pool--TZSUk1y.js";const Q={class:"widget-header"},ee={key:0,class:"disk-list"},te={class:"disk-content"},ae={class:"disk-info"},se={class:"disk-name"},re={class:"disk-path"},ne={key:0},oe={key:1},le={class:"disk-stats"},ie={key:1,class:"empty-state"},ce={name:"SmartWidget",displayName:"Status SMART"},ue=Object.assign(ce,{setup(de,{expose:z}){const c=R([]),E=R(!1),U=50,V=55;let f=null;const b=R(new Set),O={OK:"OK",ERROR:"ERR",BAD_SECTORS:"BAD SEKTORY"},I=A(()=>c.value.some(t=>!t.status||t.badSectors>0||t.outOfSpecParams.length>0||w(t.temperature,t.isSSD))?"danger":"success"),j=A(()=>{const e=c.value.filter(t=>!t.status||t.badSectors>0||t.outOfSpecParams.length>0||w(t.temperature,t.isSSD)).length;return e?`${e} BŁĘDY`:"WSZYSTKO OK"}),L=e=>e.includes("nvme")?"ph:hard-drive":"ph:hard-drives",W=e=>e.split("/").pop().toUpperCase(),w=(e,t=!1)=>e?e>(t?U:V):!1,k=e=>e.badSectors>0||e.outOfSpecParams.length>0||w(e.temperature,e.isSSD),Y=e=>e.status?e.badSectors>0?"bad-sectors":k(e)?"warning":"ok":"error",$=e=>e.badSectors>0?O.BAD_SECTORS:e.status?O.OK:O.ERROR,F=async e=>{const t=new AbortController;b.value.add(t);try{const a=(await D.get(`/api/storage/smart/details/${encodeURIComponent(e)}`,{timeout:8e3,signal:t.signal})).data?.data||{},p=a.rotation_rate===0;let d=0;if(a.ata_smart_attributes?.table){const o=a.ata_smart_attributes.table.find(h=>h.id===5),m=a.ata_smart_attributes.table.find(h=>h.id===197),q=a.ata_smart_attributes.table.find(h=>h.id===198);d=(o?.raw?.value||0)+(m?.raw?.value||0)+(q?.raw?.value||0)}const s=[];return a.ata_smart_attributes?.table&&a.ata_smart_attributes.table.forEach(o=>{o.value&&o.thresh&&o.value<=o.thresh&&s.push({id:o.id,name:o.name,value:o.value,threshold:o.thresh})}),{device:e,status:a.smart_status?.passed||!1,temperature:a.temperature?.current||Z(a),isSSD:p,badSectors:d,outOfSpecParams:s,rawData:a}}catch(n){return D.isCancel(n)||console.error(`Error fetching ${e} details:`,n),{device:e,status:!1,temperature:null,isSSD:!1,badSectors:0,outOfSpecParams:[],rawData:null}}finally{b.value.delete(t)}},Z=e=>{if(!e)return null;if(e.nvme_smart_health_information_log?.temperature)return e.nvme_smart_health_information_log.temperature-273;if(e.temperature?.current)return e.temperature.current;if(e.ata_smart_attributes?.table){const t=e.ata_smart_attributes.table.find(n=>["Temperature_Celsius","Temperature_Internal"].includes(n.name)||n.id===194);if(t?.raw?.value)return parseInt(t.raw.value)}return null},P=()=>{b.value.forEach(e=>{e.abort()}),b.value.clear()},x=async()=>{P(),E.value=!0,c.value=[];try{const t=(await D.get("/api/storage/smart/monitoring",{timeout:5e3})).data.devices||{},n=Object.keys(t).filter(a=>t[a]?.monitored===!0);n.length;for(let a=0;a<n.length;a+=2){const p=n.slice(a,a+2),d=await Promise.all(p.map(s=>F(s)));c.value.push(...d)}}catch(e){D.isCancel(e)||console.error("Error:",e),c.value=[]}finally{E.value=!1}},B=async()=>{await x()};return z({refreshData:B}),X(()=>{f&&clearInterval(f),x().finally(()=>{f=setInterval(()=>{document.visibilityState==="visible"&&B()},3e4)})}),G(()=>{P(),f&&clearInterval(f)}),(e,t)=>{const n=y("el-tag"),a=y("el-tooltip"),p=y("el-divider"),d=y("el-card");return l(),C(d,{class:"widget-card",shadow:"hover"},{header:v(()=>[r("div",Q,[_(S(g),{icon:"ph:hard-drives",width:"18"}),t[0]||(t[0]=r("span",{class:"widget-title"},"Monitorowane dyski",-1)),_(n,{type:I.value,size:"small",effect:I.value==="danger"?"dark":"plain",round:""},{default:v(()=>[J(i(j.value),1)]),_:1},8,["type","effect"])])]),default:v(()=>[c.value.length>0?(l(),u("div",ee,[(l(!0),u(K,null,M(c.value,(s,o)=>(l(),u("div",{key:s.device,class:"disk-item"},[r("div",te,[r("div",ae,[_(S(g),{icon:L(s.device),width:"16",class:"disk-icon"},null,8,["icon"]),r("span",se,i(W(s.device)),1),r("span",re,i(s.device),1),k(s)?(l(),C(a,{key:0,effect:"dark",placement:"top"},{content:v(()=>[s.badSectors>0?(l(),u("div",ne,[r("p",null,"Znalezione bad sector: "+i(s.badSectors),1)])):T("",!0),s.outOfSpecParams.length>0?(l(),u("div",oe,[t[1]||(t[1]=r("p",null,"Parametry poza normą:",-1)),r("ul",null,[(l(!0),u(K,null,M(s.outOfSpecParams,m=>(l(),u("li",{key:m.id},i(m.name)+": "+i(m.value)+" (norma: "+i(m.threshold)+") ",1))),128))])])):T("",!0)]),default:v(()=>[_(S(g),{icon:"ph:warning",width:"16",class:"warning-icon",style:{color:"var(--el-color-warning)"}})]),_:2},1024)):T("",!0)]),r("div",le,[r("div",{class:N(["temperature",{critical:w(s.temperature,s.isSSD)}])},[_(S(g),{icon:"mdi:thermometer",width:"14"}),r("span",null,i(s.temperature||"--")+"°C",1)],2),r("div",{class:N(["status",Y(s)])},i($(s)),3)])]),o<c.value.length-1?(l(),C(p,{key:0})):T("",!0)]))),128))])):(l(),u("div",ie,[_(S(g),{icon:"ph:info",width:"16"}),t[2]||(t[2]=r("span",null,"Brak dysków objętych monitoringiem",-1))]))]),_:1})}}}),fe=H(ue,[["__scopeId","data-v-067dcb89"]]);export{fe as default};
